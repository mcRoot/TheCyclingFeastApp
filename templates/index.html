<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>The Cycling Feast</title>

    <!-- Bootstrap core CSS -->
    <link href="/static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />

    <!-- Custom fonts for this template -->
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/static/css/grayscale.css" rel="stylesheet">
    <link href="/static/css/cyclingfeast.css" rel="stylesheet">

    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.css" rel='stylesheet' />

  </head>

  <body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-md navbar-light fixed-top" id="mainNav">
      <div class="container">
        <div class="navbar-header">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">The Cycling Feast</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          Menu
          <i class="fas fa-bars"></i>
        </button>
        </div>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#app">The Application</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#intro">Introduction</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#dataset">The Project</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#aboutme">About Me</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#contactme">Contact Me</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Header -->
    <header class="masthead">
      <div class="container d-sm-flex h-100 align-items-center">
        <div class="mx-auto text-center">
          <h1 class="mx-auto my-0 text-uppercase">The Cycling Feast</h1>
          <h2 class="text-white-50 mx-auto mt-2 mb-5">Eager to Ride in Italy?</h2>
          <a href="#app" class="btn btn-primary js-scroll-trigger">Try the App</a>
        </div>
        <div class="mx-auto text-center">
          <a href="http://strava.com/" target="_blank">
            <img class="tcf-opacity-50" src="/static/img/strava.png" class="img-fluid" alt="">
          </a>
        </div>
      </div>
    </header>

    <section id="app" class="app-section text-left">
      <div class="container">
        <div class="row">
           <div class="col-sm-12 mx-auto">
            <h2 class="text-black sm-4 text-center">Predict Rides!</h2>
            <p class="text-black-50">
              <b>Are you planning to visit Italy and are a eager bike rider?</b> This application helps you find
              the best Italy's locations for bike riders. Enjoy your rides in Italy then!
            </p>
             <p class="text-black-50">
              Just select the period of your visit and, on the map, click on a region you plan to visit.
               Artificial intelligence will crunch numbers under the hood and <b>predict popular areas for cycling</b>,
               showing also the top-10 climbs in the region.
            </p>
            <p class="text-black-50">
              <b>Now you have no more excuse for leaving your bike home!</b>
            </p>
           </div>
        </div>
        <div class="row">
          <div class="col-sm-4" >&nbsp;</div>
           <div class="col-sm-4">
              <div class="form-group">
                  <label for="datetimepicker1">When you want to ride?</label>
                  <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                      <input type="text" class="form-control datetimepicker-input" data-target="#datetimepicker1"/>
                      <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker">
                          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                      </div>
                  </div>
              </div>
          </div>
          <div class="col-sm-4" >&nbsp;</div>
        </div>
        <div class="row">
          <div class="col-sm-12 mx-auto">
            <div id="tcf-container" style="width: 100%; height: 500px; position: relative; outline: none;" />
          </div>
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section id="intro" class="about-section text-center">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <h1 class="text-white mb-4">The Cycling Feast</h1>
            <p class="text-white-50">
              <b>Road cycling</b> and <b>mountain biking</b> have been steadily growing in popularity in recent years due to the
              beneficial effects on health and well-being. This has been fueling an increasing interest in services for amateur riders, ranging from
              professional training programs, "cycling feasts" as well as travel-agency services and bike and component manufactures.
              Getting data to help highlight the trend of <i>"novel recruits"</i> can be fundamental to refine the aforementioned services
              and provide a better target for business.
            </p>
            <p class="text-white-50">
              Among the others, <a href="http://strava.com/" target="_blank">Strava</a>, dubbed as <i>"The Social Network of Athletes"</i> is by far the most
              well-regarded Web and mobile platform adopted by cyclists to track their activities.
              Since its start in 2009, both recreational and professional cyclists have been increasingly used the service to upload their activities
              and connect (or follow) others. One of the most peculiar features is that of segment: users can create public segments, custom road/off-road
              paths (corresponding to roads and trails in the real world) where community members can compete to obtain the best time and become the
              KOM (King of the Mountain) or QOM (Queen of the Mountain).
            </p>
            <p class="text-white-50">
              Though most of the data is (reasonably) kept strictly private, data related to segment attempts is publicly available (in an anonymized form)
              via <i>Strava REST API</i>, allowing in principle to infer trends on the popularity of cycling as a recreational sport among people.
              More specifically, I exploited the API to download the details of more than 8.000 hill and mountain climbs located in Italy: I chose Italy
              because of its "reputation" as a region of cyclists, furthermore I focused just on <i>climbs</i> as <i>those represent both a dream and a fear
              for any amateur and, among the others, one of the reasons for a fan of cycling and/or mountain biking to ride her bike.</i>

              Additionally, as can be intuitively seen in the image below
            </p>
              <p><img class="tcf-opacity-90" src="/static/img/italy-land.png" class="img-responsive" alt=""></p>
            <p class="text-white-50">
              Italy is mostly hills and mountains, precisely, <i>hills and mountains account for around <b>80%</b> of the whole Italy's territory</i>, as such we can safely state that
              climbs alone, beyond being very popular among cyclists, give quite a representative sample of "geographical riding habits" in Italy.

              So that is why, in the end, I believe that climbs can be a good starting point to depict a representative trend of the whole amateur cycling community.
            </p>
            <p class="text-white-50">
              Along with section details, such as average grade, length, elevation difference and so far, I downloaded also details of any single attempt on these segments:
              preliminary data analysis showed pretty clear trend of novel bike riders over the past few years and a strong correlation between turistic locations and
              concentration of rides. Also, time of the year and day of the week represent good indicators to discover popularity of a particular place among cyclists.
            </p>
            <p class="text-white-50">
             The ultimate goal of the project is to leverage machine learning techniques to devise models able to predict the trend (the amount) of bike rides is specific locations,
              as base to <b>develop an application to suggest bike riders the best places in Italy for cycling fans to go</b>.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Projects Section -->
    <section id="dataset" class="about-section text-left">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <h1 class="text-white mb-4">The Project</h1>
              <p class="text-white-50">
              Here we present and discuss every detail related to the project, from the dataset exploited to the analysis performed in order to develop the predictive model exploited in the actual application.
              </p>
            <h2 class="text-white mb-4">The Dataset</h2>
            <p class="text-white-50">
              The dataset has been generated via exploitation of the <a href="https://strava.github.io/api/v3/" target="_blank">Strava REST API</a>.
            <br/><br/>
               We focused on <i>Segments</i> in order to explore and gather the data of public segments located in Italy along with the corresponding <i>efforts</i>:
               this data is publicly available once you register on Strava since does not contain sensitive information about platform' users.
                In particular, we used these REST endpoint:
                <ul class="text-white-50">
                 <li><a href="https://strava.github.io/api/v3/segments/#explore">segment explorer</a>, in order to scan the geographical area of interest for relevant segments;
                 </li>
                 <li><a href="https://strava.github.io/api/v3/segments/#efforts">list efforts</a> so as to collect the comprehensive list of efforts for every segment previously collected via the segment explorer endpoint.
                 </li>
               </ul>
              <br/><br/>
              <span class="text-white-50">
              We limited the scope of the search to <i>climb segments</i> as hills and mountains can be a well representative sample of road cyclists and mountain bikers' behavior in Italy.
              Data as been collected using <i>Python</i>, exploiting <i>requests</i> module and leveraging the flexibility of <i>Pandas</i> so as to arrange the dataset in csv files.
            The resulting files and their corresponding content is described in the following sections.</span>
            </p>
          </p>
          <h3 class="text-white mb-4">Segments</h3>
          <p class="text-white-50">
            Segments are paths created by Strava users that can be shared with other members: riders can virtually "compete"
          on these segments to complete them in the shortest time possible. Segments' data can be found at
          <a href="https://github.com/mcRoot/thecyclingfeast/blob/master/dataset/strava_segments_italy_DEF.csv" target="_blank">strava_segments_italy.csv</a>.
            <br/>
            The file contains the details of around <i>6000</i> "climb" segments located in Italy covering mostly the Appennines the Alps.
            For each segment, a record is provided, showing several features:
            <ul class="text-white-50">
            <li>a <i>unique integer id</i> of the segment;</li>
             <li>the <i>name</i> of the segment (e.g. Mont Blanc climb);</li>
            <li>the <i>average grade</i>;</li>
             <li>the <i>climb category</i>, from 1 (easiest) to 5 (the so called "horse categorie");</li>
            <li>the <i>total distance</i> in meters;</li>
             <li>the <i>elevation difference</i> in meters;</li>
            <li>the data related to <i>start</i> and <i>end latitude</i> and <i>longitude</i>.</li>
           </ul>
          </p>
            <h3 class="text-white mb-4">Efforts</h3>
          <p class="text-white-50">
            The data related to efforts are organized in a series of csv files, containing the details of around <i>6,000,000</i> different efforts on the <i>6000</i>
            climbs downloaded. An <i>effort</i> corresponds to a unique attempt at completing a segment by an athlete. The downloaded efforts correspond to rides made mostly
            in the period from 2009 - January 2018, though, due to data errors, there are more than <i>200</i> activities featuring unlikely years, either way too in the past
            (1970) or in the future (2019 and further!): this is probably caused by wrong datetime setup on bike computers or smartphones used by athletes
            to upload their activities.
            <br/><br/>
            Some or the relevant data for each effort:
            <ul class="text-white-50">
            <li>the anonymized <i>athlete name</i> (only first name displayed);</li>
            <li>the <i>start date</i> in GMT timezone along with the <i>start date</i> in <i>local</i> timezone;</li>
            <li>the <i>elapsed time</i> (in seconds), i.e. the total time spent on the segment since start datetime;</li>
             <li>the <i>moving time</i> (in seconds), i.e. the total time the rider was actually pedalling (this time is usually equal or less than elapsed time);</li>
            <li>the <i>rank</i>, i.e. the position of the effort on the leaderboard, based on elapsed time, where 1 means KOM/QOM (King of the Mountain/Queen of the Mountain).</li>
           </ul>
          </p>
          <h2 class="text-white mb-4">Analysis</h2>
            <p class="text-white-50">
                We initially analyzed how amateur cycling has been evolving in Italy over the last years, selecting the period <i>2009 - 2017</i> as a reference <i>time frame</i>: in order to do so we leveraged the data collected from <a href="https://www.strava.com">Strava</a>.
            </p>
          <h3 class="text-white mb-4">Number of Kilometers Ridden</h3>
            <p class="text-white-50">
                First of all, we focussed on the total number of kilometers ridden by Strava's users over the reference period.
            </p>
              <p><img class="tcf-opacity-90" src="/static/img/prj/km-ridden.png" class="img-responsive" alt=""></p>
              <p class="text-white-50">
                  As we can see, the growth has been sort of exponential: in particular, focusing on the most recent years (2015-2017), the number of kilometers traveled doubled from 1.5 millions to almost 4 millions of kilometer.
              <br/><br/>
                  Of course, we are aware that this exponential trend can suffer from a "technological bias" caused by an increased availability of gps-enabled devices (bike computers, smartphone)
                  that have made it possible to integrate sport activities with online service such as Strava.
                  In other words, while in 2009 the number of such devices was low, the availability has been with no doubt much larger in 2015-2017, leading to a possible "technological bias" in the figures.
                  <br/>
                  However, even though the number and the availability of such devices in 2009 may have been quite low, starting from 2015, we have witnessed a relative large diffusion and availability of Internet-enabled devices, so that we can assume no "technological bias" affecting the data from 2015 on.
             <br/><br/>
              A better measure would perhaps be distance per year <i>normalized by total number of users registered to the platform in a given year</i>: unfortunately Strava does not disclose this information.
              </p>

            <h3 class="text-white mb-4">Geolocated Number of Training Sessions</h3>
            <p class="text-white-50">
                Next, we analyzed the number of training sessions (efforts) per segment, geolocated on a map so as to define a preliminary spatial correlation between users' efforts and segments where the corresponding trainings took place.
            </p>
              <p><img class="tcf-opacity-90" src="/static/img/prj/effort-geolocated.png" class="img-responsive" alt=""></p>
              <div class="text-white-50">
                  <span class="text-white-50">The chart above shows the geolocated count of segment efforts in four different years taken as reference:</span>
                  <br/>
                  <ul class="text-white-50">
                    <li>2009, selected as the year of the official kickoff of Strava, so that we going to regard efforts' quantities on this year as a sort of baseline for subsequent years.</li>
                    <li>2013, as we can suppose that the availability of gps enabled sport devices was large enough so as to represent no technological barrier to athletes to access online services such as Strava.</li>
                    <li>Finally, 2015 and 2017 represent the very recent past allowing to understand what kind of growth in the amateur cyclist community one can expected over a shorter timespan (2 years).</li>
                  </ul>
              <span class="text-white-50">Geolocalization on the map was devised by taking start latitude and longitude of each segment and plotting a dot in the corresponding point in the map. As we come closer to 2017, we can see that the number of dots increases (do not take color into account for now): that accounts for the effect of new segments added by users that very same year, in other words segments not available previously. As a consequence, just by looking at the density of dots, we can realized that, while the earlier years 2009 and 2013 witnessed a remarkable growth in the number of segments added to Strava, in 2015 and 2017 the number of new segments reached a "plateau": indeed, looking at 2013 versus 2015 and 2015 versus 2017, it is hard to spot a growth in dots' density. This effect is with no doubt due also to the fact that once a mountain or hill pass got covered by someone who created a segment and publicly shared it, there is no longer need to create a new segment for it. This also tells us that in the space of few years the whole Italy got completely covered on Strava by one or more segments.
              </span><br/><br/>
              <span class="text-white-50">The most interesting data, anyway, lies in the color of dots: lighter ones denote a higher number of efforts made on them in the given year. Looking at the evolution depicted in the map it is easy to recognize a strongly growing trend that, we think, can be regarded as a good candidate predictor of the trend in coming years. Indeed, since technology (gps and Internet enabled bike devices) does not represent anymore a barrier for people to join communities like Strava and, consequently, cannot be regarded as a bias on the data, we expect the coming years being revelatory for such a trend and, ultimately, a good reason to further investigate and analyse.
              </span></div>
               <p></p>
              <h3 class="text-white mb-4">Distribution of Rides by Month</h3>
            <p class="text-white-50">
                Let's analyse now how users' rides are distributed over the different months of the year: the chart below shows the distribution of rides by month over the whole dataset (considering year range 2009-2017).</p>
              <p><img class="tcf-opacity-90" src="/static/img/prj/effort-month.png" class="img-responsive" alt=""></p>
              <div class="text-white-50">
                  It is sort of easy to get that most of the rides in Italy occurs during <i>summertime</i> (June - August) with a peak in (July). Also, riders seems to be quite active during <i>late Spring</i> (May) and <i>early Fall</i>.
                  <br/><br/>
                   This is as well quite understandable as Italy is located in <i>temperate zone</i>. It also prove, as we were expecting, that clearly, climate has an influence on riders' habits so that future correlations with historical weather records would be helpful in devising more accurate predictive models.
              </div>
              <p></p>
              <h3 class="text-white mb-4">Distribution of Rides by Day of Week</h3>
            <p class="text-white-50">
                Let's analyse now riders' habit over the week by looking at the fashion rides are distributed among days of week. Again, the chart below shows the distribution of rides by day of week over the whole dataset (considering the usual range 2009-2017).</p>
              <p><img class="tcf-opacity-90" src="/static/img/prj/effort-dow.png" class="img-responsive" alt=""></p>
              <div class="text-white-50">
                  Again, it should come as no surprise that most of the <i>riders</i> active on Strava <i>focus their rides in the weekend</i>, most notably on Sunday: accordingly, day of week can be regarded, as well as month, as a relevant feature for predicting future number of rides.
              </div>
              <p></p>
              <h3 class="text-white mb-4">Distribution of Rides by Geographical Area</h3>
            <p class="text-white-50">
               Additionally, in order to see how a specific area might affect the amount of rides, we analyzed the density of rides in the different italian districts over the usual 2009-2017 period.
               <br/>
                In order to do so we exploited <a hfer="https://www.carto.com" target="_blank">Carto</a>, an online, "location intelligence" app.
              <p><img class="tcf-opacity-90" src="/static/img/prj/effort-latlon.png" class="img-responsive" alt=""></p>
              <div class="text-white-50">
                  A few patterns can be notices from the above geolocalized plot.
                  <br/><br/>
                  First of all, amateur cyclists seem to be more active in North/Central Italy, with the notable exception of east Sicily.
                  <br/>
                  Moreover, The Alps, and expecially Dolomites (Northmost region of Italy), show a stunning density of rides: this could be for instance explained by the fact that Dolomites are one of the UNESCO's world heritage sites, as such, visited every year by hundreds of thousands of people from all around the World.
                  <br/>
                  The same consideration may even hold for Tuscany and the renowned "Cinque Terre" that both show a very high density of rides.
                  <br/><br/>
                  In the end, we believe that geographical location of Strava's segments (latitude/longitude) plays a strong role in predicting future number of rides.
              </div>
              <p></p>
              <h3 class="text-white mb-4">Influence of Accommodation Facilites?</h3>
            <p class="text-white-50">
               Does the number of hotels in a particular area have an effect on how many rides occurr on road segments located there? We decided to pick number of hotels as a reference measure to rate how popular an area is for visitors and denote is capability of hosting potential bike riders.
               <br/><br/>
               In order to do so, we downloaded a publicly available dataset containing a well-representative list of hotels in Italy along with their corresponding latitude and longitude coordinates.
                The dataset was downloaded from <a href="http://www.datiopen.it/en/opendata/Mappa_degli_hotel_in_Italia" target="_blank">DatiOpen</a>, one of the largest italian initiatives on Open Data.
               <br/>
                Initially, we investigated the geographical density of rides correlated with the quantity of hotels in a specific area as shown in the image below.
                <p><img class="tcf-opacity-90" src="/static/img/prj/effort-hotel.png" class="img-responsive" alt=""></p>
              <div class="text-white-50">
                The heatmap represents the density of rides in the period 2009-2017, with increasing density from green to red: the pattern in this case is clearly the same as the one displayed in previous image.
                Orange clusters show instead the number of hotels in a given area, making it possible to devise a first simple (but effective) correlation between accommodations and "ride propensity" for different areas in Italy.
                As we can see, in general, areas with higher ride densities also feature higher concentrations of hotels, showing that hotels can be adopted as an additional feture to build an effective predictive model.
                 <br/><br/>
                  Then, via KMeans clustering based on <a href="http://scikit-learn.org/stable/modules/generated/sklearn.neighbors.BallTree.html#sklearn.neighbors.BallTree" target="_blank">Scikit-learn's BallTree</a>, with a distance function relying on geodesic distance (via <a href="https://geopy.readthedocs.io/en/stable/" target="_blank">Geopy</a> implementation),
                  for each Strava segment we devised the following statistical values:
                  <ul class="text-white-50">
                      <li>the nearest 100 hotels;</li>
                      <li>the average distance of those hotels from the segment;</li><
                      li>the corresponding standard deviation, median, 25 and 75 percentile values;</li>
                      <li>the number hotels within a 30-km radius.</li>
                  </ul>
                  <span class="text-white-50">These values were subsequently used as features for the base dataset of the predictive model at hand.</span>
              </div>
        </div>
      </div>
    </section>

    <section id="analysis" class="about-section text-left">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <h2 class="text-white mb-4">Exploratory Analysis</h2>
            <p class="text-white-50">

          </p>
        </div>
        </div>
      </div>
    </section>

    <!-- Signup Section -->
    <section id="signup" class="signup-section">
      <div class="container">
        <div class="row">
          <div class="col-md-10 col-lg-8 mx-auto text-center">

            <i class="far fa-paper-plane fa-2x mb-2 text-white"></i>
            <h2 class="text-white mb-5">Subscribe to receive updates!</h2>

            <form class="form-inline d-flex">
              <input type="email" class="form-control flex-fill mr-0 mr-sm-2 mb-3 mb-sm-0" id="inputEmail" placeholder="Enter email address...">
              <button type="submit" class="btn btn-primary mx-auto">Subscribe</button>
            </form>

          </div>
        </div>
      </div>
    </section>

    <!-- Contact Section -->
    <section id="contactme" class="contact-section bg-black">
      <div class="container">

        <div class="row">

          <div class="col-md-4 mb-3 mb-md-0">
            <div class="card py-4 h-100">
              <div class="card-body text-center">
                <i class="fas fa-map-marked-alt text-primary mb-2"></i>
                <h4 class="text-uppercase m-0">Address</h4>
                <hr class="my-4">
                <div class="small text-black-50">Via G. Boschi 91/A, Faenza (RA) - Italy</div>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3 mb-md-0">
            <div class="card py-4 h-100">
              <div class="card-body text-center">
                <i class="fas fa-envelope text-primary mb-2"></i>
                <h4 class="text-uppercase m-0">Email</h4>
                <hr class="my-4">
                <div class="small text-black-50">
                  <a href="#">matteo.casadei@gmail.com</a>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4 mb-3 mb-md-0">
            <div class="card py-4 h-100">
              <div class="card-body text-center">
                <i class="fas fa-mobile-alt text-primary mb-2"></i>
                <h4 class="text-uppercase m-0">Mobile</h4>
                <hr class="my-4">
                <div class="small text-black-50">+39 348 0022450</div>
              </div>
            </div>
          </div>
        </div>

        <div class="social d-flex justify-content-center">
          <a class="mx-2" href="https://www.linkedin.com/in/matteocasadei/" target="_blank">
            <i class="fab fa-linkedin"></i>
          </a>
          <a class="mx-2" href="https://github.com/mcRoot/thecyclingfeast" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        </div>

      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black small text-center text-white-50">
      <div class="container">
        Copyright &copy; The Cycling Feast - Matteo Casadei 2018
      </div>
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="/static/vendor/font-awesome/js/all.js"></script>
    <script src="/static/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- d3js for legend -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <!-- for datetime picker -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js"></script>


    <!-- Custom scripts for this template -->
    <script src="/static/js/grayscale.min.js"></script>

    <!-- for dow charts -->
    <!--<script src="/static/js/raphael-min.js"></script>
    <script src="/static/js/charts-min.js"></script>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>

  <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q==" crossorigin=""></script>
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.js"></script>
  <script src="https://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script>
  <script src="/static/js/italy-regions.js"></script>
  <script src="/static/js/spin.js"></script>
  <script src="/static/js/leaflet.spin.min.js"></script>
  <script src="/static/js/leaflet.ajax.min.js"></script>
  <script src="/static/js/leaflet-heat.js"></script>
  <script src="/static/js/thecyclingfeast.js"></script>
  <script>
      var mymap = L.map('tcf-container').setView([42, 12], 6);
      mymap.options.minZoom = 2;
      mymap.options.maxZoom = 19;
      /*var gl = L.mapboxGL({
          accessToken: 'pk.eyJ1IjoibWNyb290IiwiYSI6ImNqa2NiZXFjcDE2dnozbHBuY3Z4eWs4aGwifQ.S5I5W1XsyaTPBGicX2rgfA',
          style: 'https://openmaptiles.github.io/positron-gl-style/style-cdn.json'
      }).addTo(mymap);*/
      //mymap.fitWorld();

      var CartoDB_VoyagerNoLabels = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
          subdomains: 'abcd',
          maxZoom: 19
      }).addTo(mymap);
      var Hydda_RoadsAndLabels = L.tileLayer('https://{s}.tile.openstreetmap.se/hydda/roads_and_labels/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: 'Tiles courtesy of <a href="http://openstreetmap.se/" target="_blank">OpenStreetMap Sweden</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(mymap);
      mymap.getPane("overlayPane").style.opacity=0.8


      function style(feature) {
          return {
              weight: 2,
              opacity: 0.5,
              color: '#B05E1C',
              dashArray: '1',
              fillOpacity: 0.0
          };
      }

      var info = L.control({position: 'bottomright'});
      var heatmap;
      var legend;
      var markers = [];

      info.onAdd = function (mymap) {
            var div = L.DomUtil.create('div', 'info legend')
            var title = L.DomUtil.create('div', 'title')
            div.appendChild(title)
            title.innerHTML = '<p>Ride density levels:<p>'
            var td = L.DomUtil.create('div')
            div.appendChild(td)

            for (var i = 0; i < 18; i++) {
                td.innerHTML += '&nbsp;';
            }
            td.innerHTML += 0.4 + '&nbsp;&nbsp;&nbsp;' + 0.6 + '&nbsp;&nbsp;&nbsp;' + 0.7 + '&nbsp;&nbsp;&nbsp;' + 0.8 + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 1;

            var c = L.DomUtil.create('canvas')
            c.setAttribute('height', '60')
            var ctx = c.getContext("2d");
            var grd = ctx.createLinearGradient(0, 0, 240, 0);
            grd.addColorStop(0.4, "blue");
            grd.addColorStop(0.6, "cyan");
            grd.addColorStop(0.7, "lime");
            grd.addColorStop(0.8, "yellow");
            grd.addColorStop(1, "red");
            ctx.fillStyle = grd;
            ctx.fillRect(20, 2, 240, 30);
            div.appendChild(c)
            div.appendChild(L.DomUtil.create('div', 'stats'))
            return div;
      };

      // method that we will use to update the control based on feature properties passed
      info.update = function (region, period, props) {
        stat_text = '<p>Predicted rides for <em>' + period + '</em> in <em>' + region + '</em>: </p><ul><li>Total: <b>' + parseInt(props['tot']) + '</b> unique rides</li></ul>';
        stats = $('.stats').html(stat_text);
      };

      function highlightFeature(e) {
          var layer = e.target;

          layer.setStyle({
              weight: 5,
              color: '#666',
              dashArray: '',
              fillOpacity: 0.0
          });

          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
              layer.bringToFront();
          }

          //info.update(layer.feature.properties);
      }

      function resetHighlight(e) {
          geojson.resetStyle(e.target);
          //info.update();
      }

      function removeMarkers() {
        while (markers.length > 0) {
          m = markers.pop();
          mymap.removeLayer(m);
        }
      }

      function zoomToFeature(e, layer) {
          if (heatmap != undefined)
            mymap.removeLayer(heatmap);
          if (legend != undefined)
            mymap.removeLayer(legend);
          removeMarkers();
          mymap.spin(true);
          mymap.setView(e.target.getCenter(), 7);
          //mymap.fitBounds(e.target.getBounds());
          computedensity(e.target.feature.properties.id, layer);
          mymap.setView(e.target.getCenter(), 7);
      }

      function addLegend(points) {
        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend')
            var td = L.DomUtil.create('div')
            div.appendChild(td)

            for (var i = 0; i < 18; i++) {
                td.innerHTML += '&nbsp;';
            }
            td.innerHTML += 0.4 + '&nbsp;&nbsp;&nbsp;' + 0.6 + '&nbsp;&nbsp;&nbsp;' + 0.7 + '&nbsp;&nbsp;&nbsp;' + 0.8 + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 1;

            var c = L.DomUtil.create('canvas')
            var ctx = c.getContext("2d");
            var grd = ctx.createLinearGradient(0, 0, 240, 0);
            grd.addColorStop(0.4, "blue");
            grd.addColorStop(0.6, "cyan");
            grd.addColorStop(0.7, "lime");
            grd.addColorStop(0.8, "yellow");
            grd.addColorStop(1, "red");
            ctx.fillStyle = grd;
            ctx.fillRect(20, 2, 240, 30);
            div.appendChild(c)
            return div;
        };

        return legend.addTo(mymap);;
      }

      function addBestSegments(segments) {
        var j = 0;
        for (var seg in segments) {
          j++;
          curr = JSON.parse(segments[seg]);
          lat = curr[0]['s_lat'];
          lng = curr[0]['s_lng'];
          name = curr[0]['name'];
          id = curr[0]['segment'];
          labels = [];
          data = []
          for (var i=0;i<curr.length;i++) {
            day = curr[i]['Dow'];
            num = curr[i]['num_trainings'];
            labels.push(dow[day]);
            data.push(parseInt(num));
          }
          seg_url = segment_url + id;
          html = "<div><b>" + name + "</b><a href='" + seg_url + "' target='_blank'>See on Strava</a><canvas id='dowchart'></canvas></div>";

            var marker = L.marker([lat, lng]).addTo(mymap);
            marker.setOpacity(0.9);
            var div_chart = $('<canvas id="dowchart-' + j  + '"></canvas>');
            var div_text = $('<div>' + name + '</div>');
            var link_strava = $("<a href='" + seg_url + "' target='_blank'>See on Strava</a>");
            var div_main = $('<div></div>');
            div_main.append(div_text);
            div_main.append(link_strava);
            div_main.append(div_chart);
            marker.bindPopup(div_main[0]);
            marker.openPopup();

            new Chart(document.getElementById("dowchart-"+ j), {
                type: 'bar',
                data: {
                  labels: labels,
                  datasets: [
                    {
                      label: "Number of Rides",
                      backgroundColor: ["#B05E1C", "#B05E1C","#B05E1C","#B05E1C","#B05E1C","#B05E1C","#B05E1C"],
                      data: data
                    }
                  ]
                },
                options: {
                  legend: { display: false },
                  title: {
                    display: true,
                    text: 'Distribution of Rides over Week'
                  }
                }
            });
            marker.closePopup();

          markers.push(marker);

        }
      }


      function computedensity(id, layer) {
        $.ajax("/training/" + id + "/predict", {
          "data": {'period': $('#datetimepicker1 input').val()},
          "success": function(data) {
              res = JSON.parse(data);
               //if (legend === undefined)
               // legend = addLegend(res["legend"]);
               info.update(res['region_name'], res['period'], res['stats']);
               addBestSegments(res['best_segments']);
               var heat = L.heatLayer(res["res"], {minOpacity: 0.01, radius: 10, blur: 27, maxZoom: 7}).addTo(mymap);
               heatmap = heat;
               mymap.spin(false);
          },
          "error": function() {
              console.log("an error occurred");
              mymap.spin(false);
          }
        });
      }

      function onEachFeature(feature, layer) {
          layer.on({
              mouseover: highlightFeature,
              mouseout: resetHighlight,
              click: function(e) {
                zoomToFeature(e, layer)
              }
          });
      }

      geojson = L.geoJson(italy_regions, {style: style,onEachFeature: onEachFeature}).addTo(mymap);
      info.addTo(mymap);


      $('#datetimepicker1').datetimepicker({
        format: "MM/YYYY",
        viewMode: "years",
        defaultDate: '07/01/2018'
      });



    </script>
  </body>

</html>
